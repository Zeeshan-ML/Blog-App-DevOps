// File: blog-app/selenium-tests/Jenkinsfile
pipeline {
    agent any
    
    environment {
        DOCKER_IMAGE = 'blog-app-tests'
        APP_URL = 'http://3.232.241.183:3000'  // Your application EC2 IP
        APP_IMAGE = 'zeeshanml/blog-app'
        NEW_PORT = '3001'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'Checking out code from GitHub...'
                checkout scm
            }
        }
        
        stage('Deploy Updated App') {
            steps {
                echo 'Deploying updated application on port 3001...'
                script {
                    sh """
                        docker pull ${APP_IMAGE}:latest
                        docker stop blog-app-new || true
                        docker rm blog-app-new || true
                        docker run -d --name blog-app-new -p ${NEW_PORT}:3000 \
                            -v blog-data-new:/app/data \
                            --network bridge \
                            ${APP_IMAGE}:latest
                        sleep 10
                    """
                }
            }
        }
        
        stage('Build Test Image') {
            steps {
                echo 'Building Docker image for tests...'
                dir('selenium-tests') {
                    script {
                        docker.build("${DOCKER_IMAGE}:${BUILD_NUMBER}")
                    }
                }
            }
        }
        
        stage('Run Tests') {
            steps {
                echo 'Running Selenium tests on newly deployed app...'
                script {
                    try {
                        sh """
                            docker run --rm \
                                --network host \
                                -v \$(pwd)/selenium-tests:/tests \
                                -e BASE_URL=http://100.31.20.109:${NEW_PORT} \
                                ${DOCKER_IMAGE}:${BUILD_NUMBER}
                        """
                    } catch (Exception e) {
                        echo "Tests failed: ${e.message}"
                        currentBuild.result = 'UNSTABLE'
                    }
                }
            }
        }
        
        stage('Generate Report') {
            steps {
                echo 'Generating test report...'
                publishHTML([
                    allowMissing: false,
                    alwaysLinkToLastBuild: true,
                    keepAll: true,
                    reportDir: 'selenium-tests',
                    reportFiles: 'report.html',
                    reportName: 'Selenium Test Report'
                ])
            }
        }
    }
    
    post {
        always {
            echo 'Cleaning up...'
            sh "docker rmi ${DOCKER_IMAGE}:${BUILD_NUMBER} || true"
            
            // Email notification - extract Git author email directly
            script {
                def gitAuthorEmail = sh(
                    script: "git log -1 --pretty=format:'%ae'",
                    returnStdout: true
                ).trim()
                
                emailext(
                    subject: "Jenkins Build ${currentBuild.result}: ${env.JOB_NAME} - Build #${env.BUILD_NUMBER}",
                    body: """
                        <h2>Build ${currentBuild.result}</h2>
                        <p><b>Project:</b> ${env.JOB_NAME}</p>
                        <p><b>Build Number:</b> ${env.BUILD_NUMBER}</p>
                        <p><b>Build URL:</b> <a href="${env.BUILD_URL}">${env.BUILD_URL}</a></p>
                        <p><b>Test Report:</b> <a href="${env.BUILD_URL}Selenium_20Test_20Report/">View Report</a></p>
                        <hr>
                        <p>${currentBuild.result == 'SUCCESS' ? 'All tests passed!' : 'Some tests failed. Check the report.'}</p>
                    """,
                    to: gitAuthorEmail,
                    mimeType: 'text/html',
                    attachLog: true
                )
            }
        }
        success {
            echo 'Pipeline completed successfully!'
        }
        failure {
            echo 'Pipeline failed!'
        }
    }
}
