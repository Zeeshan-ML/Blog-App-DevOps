version: '3.8'

services:
  # Web Application Service (Next.js blog)
  web:
    image: zeeshanml/blog-app   # ✅ Pulls pre-built image from DockerHub
    container_name: blog-app-web
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_BASE_URL=http://100.31.20.109:3000   # ✅ Updated for EC2 public IP
    volumes:
      - blog-data:/app/data   # persistent SQLite database
    restart: unless-stopped
    networks:
      - blog-network
    depends_on:
      - db-backup
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Database Backup Service (persistent volume)
  db-backup:
    image: alpine:latest
    container_name: blog-db-backup
    volumes:
      - blog-data:/data
      - blog-backups:/backups
    command: >
      sh -c "
      while true; do
        echo 'SQLite volume mounted at /data';
        if [ -f /data/blog.db ]; then
          cp /data/blog.db /backups/blog-backup-$$(date +%Y%m%d-%H%M%S).db || true;
          echo 'Backup saved ✅';
        else
          echo 'Database file not yet created';
        fi;
        sleep 3600;
      done
      "
    restart: unless-stopped
    networks:
      - blog-network

# Named volumes for persistence
volumes:
  blog-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data
  blog-backups:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./backups

# Network for inter-container communication
networks:
  blog-network:
    driver: bridge
