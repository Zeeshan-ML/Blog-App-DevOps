version: '3.8'

services:
  # Web Application Service (Next.js blog)
  web:
    image: zeeshanml/blog-app
    container_name: blog-app-web-ci   # ✅ Different container name for CI/CD
    ports:
      - "3100:3000"   # ✅ Different port for CI/CD deployment
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_BASE_URL=http://100.31.20.109:3100  # ✅ Update for CI/CD port
    volumes:
      - ./app:/app    # ✅ Mount code from Jenkins workspace
      - blog-data:/app/data
    restart: unless-stopped
    networks:
      - blog-network
    depends_on:
      - db-backup
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Database Backup Service
  db-backup:
    image: alpine:latest
    container_name: blog-db-backup-ci   # ✅ Different container name
    volumes:
      - blog-data:/data
      - blog-backups:/backups
    command: >
      sh -c "
      while true; do
        if [ -f /data/blog.db ]; then
          cp /data/blog.db /backups/blog-backup-$$(date +%Y%m%d-%H%M%S).db || true
        fi
        sleep 3600
      done
      "
    restart: unless-stopped
    networks:
      - blog-network

# Named volumes for persistence
volumes:
  blog-data:
  blog-backups:

# Network for inter-container communication
networks:
  blog-network:
    driver: bridge
